# MyMfe

<a alt="Nx logo" href="https://nx.dev" target="_blank" rel="noreferrer"><img src="https://raw.githubusercontent.com/nrwl/nx/master/images/nx-logo.png" width="45"></a>

✨ **This workspace has been generated by [Nx, Smart Monorepos · Fast CI.](https://nx.dev)** ✨

✨ **[Native federation, @angular-architects/native-federation ](https://www.npmjs.com/package/@angular-architects/native-federation?activeTab=readme) is used to create micro-frontend architecture** ✨

✨ **[Kendo UI for Angular](https://www.telerik.com/kendo-angular-ui/components/getting-started/) is used for UI components** ✨

✨ **[Okta Angular SDK](https://github.com/okta/okta-angular) is used to add authentication and authorization** ✨

✨ **Dynamic Layouts** ✨

## Start the application

✨ **Clone the repo**, do the `npm install` and:

Run `npx nx serve shell` to start the development server (shell).

Run `npx nx serve remote1` to start the remote1 development server (mfe1).

Run `npx nx serve voya-me` to start the voya-me development server (mfe2).

Happy coding!

## Project Setup tasks

**If you want to create similar setup follow the setup tasks below.**

✨ To create **shell** app and setup native federation with Nx use the following cmd:

```
npx nx g @nx/angular:app shell --directory=apps/shell
```

Create Home Module and HomeComponent in shell app:

```
npx nx g module home-shell --project shell
npx nx g component home --module=app-routing --directory=apps/shell/src/app
```

Install Native federation on shell:

```
npx nx add @angular-architects/native-federation --project shell --port 4200 --type dynamic-host
```

✨ To create **remote1** app and setup native federation with Nx use the following cmd:

```
npx nx g @nx/angular:app remote1 --directory=apps/remote1
```

Create Home Module and HomeComponent in remote1 app:

```
npx nx g module remote-main --project remote1
npx nx g component home --module=remote-main --directory=apps/remote1/src/app
```

Install Native federation on remote1:

```
npx nx add @angular-architects/native-federation --project remote1 --port 4201
```

✨ To create **voya-me** app and setup native federation with Nx use the following cmd:

```
npx nx g @nx/angular:app voya-me --directory=apps/voya-me
```

Create Home Module and HomeComponent in voya-me app:

```
npx nx g module remote-main --project voya-me
npx nx g component home --module=remote-main --directory=apps/voya-me/src/app
```

Install Native federation on voya-me:

```
npx nx add @angular-architects/native-federation --project voya-me --port 4202
```

✨ To create **shared lib** with Nx use the following cmd:

```
npx nx g @nx/angular:library shared-ui --directory=libs/shared/ui --standalone
```

✨ To Add **Kendo UI** use the following cmd:

```
npm install --save @progress/kendo-licensing
```

After installation **activete kendo-ui-license**, download the kendo-ui-license.txt have is on root and run below cmd

```
npx kendo-ui-license activate
```

keep adding required **Kendo UI components** use the following cmd:

```
npm install @progress/kendo-angular-grid --save
npm install @progress/kendo-data-query --save
npm install @progress/kendo-theme-default --save
```

## Key Setup files and code

**mfe federation.config.js**

```

const {
  withNativeFederation,
  shareAll,
} = require('@angular-architects/native-federation/config');

module.exports = withNativeFederation({
  name: 'remote1',

  exposes: {
    './remote1Module':
      './apps/remote1/src/app/remote-main/remote-main.module.ts',
  },

  shared: {
    ...shareAll({
      singleton: true,
      strictVersion: true,
      requiredVersion: 'auto',
    }),
  },

  skip: [
    'rxjs/ajax',
    'rxjs/fetch',
    'rxjs/testing',
    'rxjs/webSocket',
    // Add further packages you don't need at runtime
  ],

  // Please read our FAQ about sharing libs:
  // https://shorturl.at/jmzH0
});

```

**mfe src/main.ts**

```
import { initFederation } from '@angular-architects/native-federation';

initFederation()
  .catch((err) => console.error(err))
  .then((_) => import('./bootstrap'))
  .catch((err) => console.error(err));

```

**shell federation.config.js**

```

const {
  withNativeFederation,
  shareAll,
} = require('@angular-architects/native-federation/config');

module.exports = withNativeFederation({
  shared: {
    ...shareAll({
      singleton: true,
      strictVersion: false,
      requiredVersion: false, //'auto',
    }),
  },

  skip: [
    'rxjs/ajax',
    'rxjs/fetch',
    'rxjs/testing',
    'rxjs/webSocket',
    // Add further packages you don't need at runtime
  ],
});


```

**shell src/assets/federation.manifest.json**

```

{
  "remote1": "http://localhost:4201/remoteEntry.json",
  "voya-me": "http://localhost:4202/remoteEntry.json",
  "angular-mfe": "http://localhost:4203/remoteEntry.json",
  "react-mfe": "http://localhost:3001/remoteEntry.json"
}

```

**shell src/assets/appSetting.json** this holds the route object with layout

```

[
  {
    "title": "Home",
    "description": "This is shell app",
    "iconFlag": "k-i-home",
    "path": "",
    "layout": "KendoAppbarComponent",
    "featureModule": "home/home"
  },
  {
    "title": "Profile",
    "iconFlag": "k-i-user",
    "path": "profile",
    "layout": "KendoAppbarComponent",
    "featureModule": "profile/profile",
    "protected": true
  },
  {
    "title": "Protected",
    "path": "protected",
    "iconFlag": "k-i-lock",
    "layout": "KendoAppbarComponent",
    "featureModule": "protected/routes",
    "protected": true
  },
  {
    "title": "Remote application",
    "description": "Remote app with native fedration",
    "path": "remote",
    "layout": "KendoDrawerComponent",
    "remoteModule": {
      "name": "remote1",
      "exposes": "./remote1Module",
      "module": "RemoteMainModule"
    },
    "iconFlag": "k-i-inherited"
  },
  {
    "title": "Voya ME Remote",
    "description": "Voya Remote app with native fedration",
    "path": "voya-me",
    "layout": "KendoDrawerComponent",
    "remoteModule": {
      "name": "voya-me",
      "exposes": "./voyaMEModule",
      "module": "RemoteMainModule"
    },
    "iconFlag": "k-i-puzzle-piece"
  },
  {
    "title": "Angular External Remote App",
    "description": "External repo Remote app with native fedration",
    "path": "ext-remote",
    "layout": "KendoAppbarComponent",
    "remoteModule": {
      "name": "angular-mfe",
      "exposes": "./ExtAngularApp",
      "module": "RemoteMainModule"
    },
    "iconFlag": "k-i-edit-tools"
  },
  {
    "title": "React External Remote App",
    "description": "External React app with shell wrapper",
    "iconFlag": "k-i-table-position-center",
    "path": "ext-react-app",
    "layout": "KendoAppbarComponent",
    "featureModule": "react-app-wrapper/react-app-wrapper"
  }
]


```

**shell src/main.ts**

```

import { initFederation } from '@angular-architects/native-federation';

initFederation('/assets/federation.manifest.json')
  .catch((err) => console.error(err))
  .then((_) => import('./bootstrap'))
  .catch((err) => console.error(err));

```

**shell src/bootstrap.ts**

```

import { bootstrapApplication } from '@angular/platform-browser';
import { getAppConfig } from './app/app.config';
import { AppComponent } from './app/app.component';

getAppConfig().then((config) =>
  bootstrapApplication(AppComponent, config).catch((err) => console.error(err))
);

```

**shell src/app/app.config.ts**

```

import {
  APP_INITIALIZER,
  ApplicationConfig,
  importProvidersFrom,
} from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { BrowserAnimationsModule } from '@angular/platform-browser/animations';
import {
  provideRouter,
  withEnabledBlockingInitialNavigation,
} from '@angular/router';
import { OktaAuthConfigService, OktaAuthModule } from '@okta/okta-angular';
import { OktaAuth } from '@okta/okta-auth-js';
import {
  HttpBackend,
  HttpClient,
  provideHttpClient,
  withInterceptors,
} from '@angular/common/http';
import { tap, take } from 'rxjs';

import { getAppRoutes } from './app.routes';
import { authInterceptor } from './auth.interceptor';

function configInitializer(
  httpBackend: HttpBackend,
  configService: OktaAuthConfigService
): () => void {
  return () =>
    new HttpClient(httpBackend).get('api/config.json').pipe(
      tap((authConfig: any) =>
        configService.setConfig({
          oktaAuth: new OktaAuth({
            ...authConfig,
            redirectUri: `${window.location.origin}/login/callback`,
          }),
        })
      ),
      take(1)
    );
}
export async function getAppConfig(): Promise<ApplicationConfig> {
  const routes = await getAppRoutes();
  return {
    providers: [
      importProvidersFrom([
        OktaAuthModule,
        BrowserModule,
        BrowserAnimationsModule,
      ]),
      provideRouter(routes, withEnabledBlockingInitialNavigation()),
      provideHttpClient(withInterceptors([authInterceptor])),
      {
        provide: APP_INITIALIZER,
        useFactory: configInitializer,
        deps: [HttpBackend, OktaAuthConfigService],
        multi: true,
      },
    ],
  };
}

```

**shell src/app/app.routes.ts**

```

import { Route } from '@angular/router';
import { loadRemoteModule } from '@angular-architects/native-federation';
import { OktaAuthGuard, OktaCallbackComponent } from '@okta/okta-angular';

export async function getAppRoutes(): Promise<Route[]> {
  const res = await fetch('assets/appSetting.json');
  const data = await res.json();
  const route = data.map((route: any) => {
    if (route.remoteModule)
      return {
        path: route.path,
        loadComponent: () =>
          import('@shell/shared-ui').then((m: any) => m[route.layout]), // Dynamic import based on layout
        loadChildren: () =>
          loadRemoteModule(
            route.remoteModule.name,
            `${route.remoteModule.exposes}`
          ).then((m) => m[route.remoteModule.module]), // Dynamic import based on remote module
      };
    else {
      return {
        path: route.path,
        pathMatch: route.path ? '' : 'full',
        loadComponent: () =>
          import('@shell/shared-ui').then((m: any) => m[route.layout]),
        loadChildren: async () => {
          return import(`./${route.featureModule}.module.ts`).then((m) => {
            return m.default;
          });
        },
      };
    }
  });
  route.push({ path: 'login/callback', component: OktaCallbackComponent });
  return route;
}

```

**shell src/app/app.routes.ts** for simple app without dynamic layouts

```

import { Routes } from '@angular/router';
import { loadRemoteModule } from '@angular-architects/native-federation';
import { ReactAppWrapperComponent } from './react-app-wrapper/react-app-wrapper.component';
import { HomeComponent } from './home/home.component';

export const routes: Routes = [
  {
    path: '',
    component: HomeComponent,
  },
  {
    path: 'angular-remote',
    loadComponent: () =>
      loadRemoteModule('angular-mfe', './Component').then(
        (m) => m.AppComponent
      ),
  },
  {
    path: 'react-remote',
    component: ReactAppWrapperComponent,
  },
];

```

**shell src/app/react-app-wrapper/react-app-wrapper.component.ts**

```

import { Component, OnInit, ViewChild, ElementRef } from '@angular/core';
import { loadRemoteModule } from '@softarc/native-federation-runtime';

@Component({
  selector: 'app-react-app-wrapper',
  standalone: true,
  imports: [],
  templateUrl: './react-app-wrapper.component.html',
  styleUrl: './react-app-wrapper.component.css',
})
export class ReactAppWrapperComponent implements OnInit {
  @ViewChild('reactmfe', { static: true }) containerRef!: ElementRef;

  ngOnInit() {
    loadRemoteModule('react-mfe', './ReactApp').then((m) => {
      console.log('remote react mfew::', m);
      m.mount(this.containerRef.nativeElement);
    });
  }
}

```

**shell src/app/react-app-wrapper/react-app-wrapper.component.html**

```

<div #reactmfe>placeholder react app...</div>

```

**react-mfe package.json libraries**

```

  "scripts": {
    "build:remote": "tsc build/build-mfe1.ts --outDir dist && node dist/build-mfe1.js",
    "start:remote": "live-server dist/react-mfe --port=3001 --cors",
  },
  "dependencies": {
    "@softarc/native-federation-runtime": "^2.0.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@softarc/native-federation": "^2.0.0",
    "@softarc/native-federation-esbuild": "^2.0.9",
    "@types/node": "^20.5.9",
    "concurrently": "^8.2.1",
    "esbuild": "^0.19.2",
    "json5": "^2.2.3",
    "live-server": "^1.2.2",
    "typescript": "^5.2.2"
  }

```

**react-mfe federation.config.js**

```

const {
  withNativeFederation,
  shareAll,
} = require("@softarc/native-federation/build");

module.exports = withNativeFederation({
  name: "remote-mfe",

  exposes: {
    "./ReactApp": "./src/bootstrap",
  },

  shared: {
    ...shareAll({
      singleton: true,
      strictVersion: true,
      requiredVersion: "auto",
      includeSecondaries: false,
    }),
  },
});

```

**react-mfe src/index.js**

```

import { initFederation } from "@softarc/native-federation";

(async () => {
  await initFederation();
  await import("./bootstrap");
})();

```

**react-mfe src/bootstrap.jsx**

```

import React from "react";
import ReactDOM from "react-dom";
import App from "./App";

const mount = (el) => {
  ReactDOM.render(
    <React.StrictMode>
      <App />
    </React.StrictMode>,
    el
  );
};
const devRoot = document.querySelector("#root");
if (devRoot) {
  mount(devRoot);
}
export { mount };

```

**react-mfe build/build-mfe1.ts** for esbuild setups:

```

import { buildProject } from "./build-common";

buildProject("react-mfe");

```

**react-mfe build/build-common.ts**

```

import * as esbuild from "esbuild";
import * as path from "path";
import * as fs from "fs";
import { esBuildAdapter } from "@softarc/native-federation-esbuild";
import { federationBuilder } from "@softarc/native-federation/build";

export async function buildProject(projectName) {
  const tsConfig = "tsconfig.json";
  const outputPath = `dist/${projectName}`;
  /*
   *  Step 1: Initialize Native Federation
   */

  await federationBuilder.init({
    options: {
      workspaceRoot: path.join(__dirname, ".."),
      outputPath,
      tsConfig,
      federationConfig: `/federation.config.js`,
      verbose: false,
    },

    /*
     * As this core lib is tooling-agnostic, you
     * need a simple adapter for your bundler.
     * It's just a matter of one function.
     */
    adapter: esBuildAdapter,
  });

  /*
   *  Step 2: Trigger your build process
   *
   *      You can use any tool for this. Here, we go with a very
   *      simple esbuild-based build.
   *
   *      Just respect the externals in `federationBuilder.externals`.
   */

  fs.rmSync(outputPath, { force: true, recursive: true });

  await esbuild.build({
    entryPoints: [path.join(__dirname, "../src/index.js")],
    external: federationBuilder.externals,
    outdir: outputPath,
    bundle: true,
    platform: "browser",
    loader: { ".js": "jsx" },
    format: "esm",
    mainFields: ["es2020", "browser", "module", "main"],
    conditions: ["es2020", "es2015", "module"],
    resolveExtensions: [".ts", ".tsx", ".mjs", ".js", ".jsx"],
    tsconfig: tsConfig,
    splitting: true,
  });

  fs.copyFileSync(
    path.join(__dirname, "../public/index.html"),
    `dist/${projectName}/index.html`
  );
  fs.copyFileSync(
    path.join(__dirname, "../public/favicon.ico"),
    `dist/${projectName}/favicon.ico`
  );

  //fs.copyFileSync(`${projectName}/styles.css`, `dist/${projectName}/styles.css`);

  /*
   *  Step 3: Let the build method do the additional tasks
   *       for supporting Native Federation
   */

  await federationBuilder.build();
}
```

> **[!CAUTION]**
> (if mfe is not in Nx monorepo)

$${\color{red}Potential \space Error \space Due  \space to  \space Angular  \space Version  \space Mismatc \space in  \space Shell  \space and  \space MFE.}$$

```
- Below Error will appear if **angular version mismatch** in shell and mfe (if mfe is not in Nx monorepo)

ERROR Error: NG0203: inject() must be called from an injection context such as a constructor, a factory function, a field initializer, or a function used with `runInInjectionContext`. Find more at https://angular.io/errors/NG0203
    at injectInjectorOnly (_angular_core-17_3_12-dev.js:677:11)
    at Module.ɵɵinject (_angular_core-17_3_12-dev.js:687:59)
    at Object.RouterModule_Factory [as useFactory] (_angular_router-17_3_12-dev.js:5354:42)
    at Object.factory (_angular_core-17_3_8-dev.js:1979:32)
    at _angular_core-17_3_8-dev.js:1900:35
    at runInInjectorProfilerContext (_angular_core-17_3_8-dev.js:563:5)
    at R3Injector.hydrate (_angular_core-17_3_8-dev.js:1899:11)
    at R3Injector.get (_angular_core-17_3_8-dev.js:1789:23)
    at injectInjectorOnly (_angular_core-17_3_8-dev.js:681:36)
    at ɵɵinject (_angular_core-17_3_8-dev.js:687:59)

```

## Build for production

Run `npx nx build shell` to build the application. The build artifacts are stored in the output directory (e.g. `dist/` or `build/`), ready to be deployed.

## Running tasks

To execute tasks with Nx use the following syntax:

```
npx nx <target> <project> <...options>
```

You can also run multiple targets:

```
npx nx run-many -t <target1> <target2>
```

..or add `-p` to filter specific projects

```
npx nx run-many -t <target1> <target2> -p <proj1> <proj2>
```

Targets can be defined in the `package.json` or `projects.json`. Learn more [in the docs](https://nx.dev/features/run-tasks).

## Set up CI!

Nx comes with local caching already built-in (check your `nx.json`). On CI you might want to go a step further.

- [Set up remote caching](https://nx.dev/features/share-your-cache)
- [Set up task distribution across multiple machines](https://nx.dev/nx-cloud/features/distribute-task-execution)
- [Learn more how to setup CI](https://nx.dev/recipes/ci)

## Explore the project graph

Run `npx nx graph` to show the graph of the workspace.
It will show tasks that you can run with Nx.

- [Learn more about Exploring the Project Graph](https://nx.dev/core-features/explore-graph)

## Connect with us!

- [Join the community](https://nx.dev/community)
- [Subscribe to the Nx Youtube Channel](https://www.youtube.com/@nxdevtools)
- [Follow us on Twitter](https://twitter.com/nxdevtools)
